![Amazon Q Developer header](/images/q-vscode-header.png)

## Amazon Q Developerを使いこなす

アプリケーションを構築する前に、Amazon Qのさまざまな機能がどのように動作するのかを理解するための演習をいくつか行います。

> **他の生成AIコーディングツールを使っていますか？**
>
>現在、生成AIツール（Continue、Supermaven、Copilotなど）を使用している場合、キーボードショートカットの一部が機能しないことがあります。このワークショップの期間中、使用している他のAIコーディングツールを見つけ、一時的に無効にしてください。これを行うには、プラグインのセクションに行き、プラグインを探し、設定から無効化を選択します。
>

新しいディレクトリを作成し、新しいVSCodeインスタンスを起動します。
基本的な確認事項をこのディレクトリを使って確認します。
このステップが完了したら、すべてを終了します。

```
mkdir q-sandbox
cd q-sandbox
code .
```

---

### 1. インラインエディタを使う

Amazon Q Developerを使えば、エディタ内でコードを書くときに役立ちます。
この節では、ツールを最大限に活用する方法について自信を持つために、これらがどのように機能するかを説明します。

**基本機能**

Amazon Qは、コード候補を提供するために使用される指示（プロンプト）を入力するさまざまな方法をサポートしています。
これらをまとめると以下のようになります。

* 関数プロンプト
* 1行コメント
* 複数行コメント
* 1行プロンプト
* 複数行プロンプト
* インラインプロンプト

インラインプロンプトを除き、プロンプトを入力してリターンを押すと、Amazon Qが起動し、いくつかのコード候補が表示されます。
左右のカーソルキーを使用してオプションを再表示できます。
たまにコード候補が1つしか出ない場合がありますが、そのときは<キーと>キーを使っても異なる出力は得られません。

コードの候補がグレーアウトしていることにお気づきでしょう。
提案を受け入れるには、TABキーを押します。

これらのコード提案はデフォルトで自動的に行われます。
次の節では、この動作を変更する方法を説明します。

**関数プロンプト**

1/ Amazon Q Developerはあなたの意図を理解し、関数名に基づいて提案を行います。
関数名がより説明的であればあるほど、より良い提案が得られます。

VSCodeで新しいファイルを開き、次のように入力しましょう。

```python
def towers_of_hanoi(
```

コピペしても良いですよ！

2/ `(` を押すと、Amazon Q Developerがすでにあなたが何をしたいかを予測し、いくつかのコード案を提示しているのが確認できるはずです。
カーソルキーの<と>で候補を切り替え、TABで受け入れるか、ESCで終了できます。

たとえば、他の関数名で試すこともできます。

```python
def get_average(numbers):
```

3/ ファイルにコードを追加すると、Amazon Qはこれを考慮します。
あなたが望むもの（たとえば、docstring、変数名や関数名のスタイルガイドとの一致など）をすべて備えた関数をコードの先頭に1つ作成することができ、さらに関数を追加すると、その構造がコピーされます。

たとえば、ファイルの先頭に以下を追加します（追加したものはすべて削除してかまいません）。

```python
def get_average(numbers):
    """
    Calculate the average of a list of numbers.

    Args:
    numbers (list): A list of numbers (int or float).

    Returns:
    float: The average of the numbers in the list.

    Raises:
    ValueError: If the input list is empty.
    TypeError: If the input list contains non-numeric elements.

    Example:
    >>> get_average([1, 2, 3, 4, 5])
    3.0
    >>> get_average([])
    Raises ValueError: Empty list provided
    >>> get_average([1, 2, 'a', 4, 5])
    Raises TypeError: List contains non-numeric elements
    """
    if not numbers:
        raise ValueError("Empty list provided")

    if not all(isinstance(num, (int, float)) for num in numbers):
        raise TypeError("List contains non-numeric elements")

    return sum(numbers) / len(numbers)
```

returnを数回押して、次のように入力します。

```python
def get_mean(numbers)
```

あなたが「標準」として定義したものと非常によく似た定型的なコードが生成されるのがわかるはずです。
これは、あなたが望むものすべてを確実に維持しながら、非常に素早くコードを書くことを可能にする非常に素晴らしい機能です。

**1行コメント**

4/ Amazon Q Developerはあなたの意図を理解し、1行のコメントに基づいて提案を提供します。
たとえば、IDEで次のように入力します。

```python
# function to print a message
```

returnを押すと、Amazon Qがいくつかのコードを提案してくれます。

**複数行コメント**

5/ これは前のものと同じ働きをしますが、コメントを何行にもわたって書くことができます。
たとえば、IDEで次のように入力します。

```python
"""
Given a list that contains some numbers and strings,
format the list elements into a string in which the numbers are prepended with a "#"
and check for strings and wrap in a double quote.
"""
```

Enterキーを押すと、Amazon Qがコードを提案してくれるはずです。

**1行プロンプト**

6/ Amazon Q Developerはあなたが入力したプロンプトに基づいてあなたの意図を理解し、作業中のファイル内で提案を行います。
たとえば、次のように入力してEnterキーを押します。

```python
# CREATE a function called get user age, ask the user to input their age, and RETURN the user's age
```

この1行のプロンプトをもとにコードが作成されるのがわかるでしょう。

**複数行プロンプト**

7/ これは、プロンプトを複数の行に書くことができることを除けば、前のものとまったく同じように機能します。
たとえば次のような形です。

```python
 # CREATE a function called get user age
 # ask the user to input their age
 # RETURN the user's age
```

**自動プロンプトの有効化と無効化**

8/ Amazon Q Developerを使い始めるに当たって考えなければならないことは、コードを書いている最中に自動的にコード提案をさせたいのか、それともコマンドラインを使って手動で呼び出したいのかということです。

自動サジェストの有効/無効は、Amazon Qメニューを表示したときに「自動サジェストの一時停止（Pause Auto Suggestions）」をクリックすることで設定できます（VSCodeのステータスバー下部にあるAmazon Qをクリック）。

これで実験してみましょう。
新しいファイル(experiment.py)を開き、その一番上に次のように書いてください。

```python
# Add Python library imports for Flask and SQLAlcamey
```

Enterを押してください。
コードの候補を表示する前に、Amazon Qが考えていることがわかるはずです（灰色で表示されます）。

次に、Amazon Qの設定に行き、自動サジェストを無効にします。
アイコンが一時停止アイコンのようになるはずです。
同じファイルから、以前に作成したものをすべて削除し、同じものを入力します。

```python
# Add Python library imports for Flask and SQLAlcamey
```

今度はEnterを押しても何も出力されないはずです。
しかし、カーソルを最後まで移動し、OPTION + C（Mac）、ALT + C（Windows）を押すと、今度はAmazon Qがいくつかの提案をするはずです。
タブを押して同意し、Enterを押してもう一度OPTION/ALT + Cを押すと、さらなる提案が表示されます。

ワークショップで使用するため、自動提案を再度有効にしてください。

**インラインプロンプト**

9/ インラインプロンプトの動作は若干異なる。
使用できるモードは2つあります。

* 現在開いているファイル内でカーソルがある位置のどちらかから
* コードブロックの選択

動作は似ています。
COMMAND + Iで起動し、コマンドプロンプトウィンドウが表示されます。
これが表示されない場合、確認すべきことが2つあります。

1. 他のVSCodeプラグインがCOMMAND + Iと競合していないことを確認してください - 私がこのワークショップを書いているとき、COMMAND + Iが動作せず、他のプラグインを無効にしなければなりませんでした。
2. フォーカスが実際に開いているファイル内にあることを確認する - チャットインターフェースかファイルエクスプローラーにフォーカスが当たっていることがよくあります。開いているファイル内をクリックして確実にフォーカスがファイルに当たっているようにします。

プロンプトを入力すれば、あとは動き出すだけです。
以前の方法のように、異なるコードセグメントを選択することはできません。
新しいコードまたは変更/削除されたコードに基づいて、コードブロックが緑/赤でハイライトされ、提案を受け入れる（Enter）または拒否する（ESC）オプションが表示されます。

このモードはとても強力で、コードの更新や変更のスピードを向上させてくれます。
たとえば、既存のコードブロックの更新、新しい関数の追加、オプションのリクエスト、try/catchブロックの追加などで使えます。

*ソフトウェアの品質*

10/ 私がインラインプロンプトを使う手っ取り早い方法は、コードが生成するエラーの量を減らせるようにすることによって、生成されるコードの質を向上させることです。
Amazon Qがこれを簡単にする2つの方法は、エラー処理を追加することと、ネガティブスペースプログラミングのようなテクニックを実装することです。

VSCodeで "quality.py"という新しいファイルを作成し、[このファイル](https://github.com/094459/porto-techhub-amazon-q-workshop/blob/main/resources/in-line.py)の内容をコピーします。
そしてファイルを保存します。

このコードブロックを選択します。

```python
@app.route('/hello/<name>')
def hello_name(name):
    return 'Hello %s!' % name
```

COMMAND + Iを押してインラインプロンプトを表示し、次のように入力します。

> add error handling to this function

出力を確認します。
コードを理解したら、一旦このコードは受け入れたくないので、ESCキーを押してください。

同じコードをハイライトし、もう一度インラインエディタを起動します。
今度はこのプロンプトを使います。

> apply negative space programming to this function

出力結果を見直します。
どう違いましたか。
同じコードブロックに両方を適用することもできます。
もう一度 ESC を押して、コードを却下します。
ファイルを閉じて削除します("quality.py")。

---

### 2. VSCodeメニュー統合の使用

メインのエディターから、メニューの統合を通してAmazon Qを呼び出すことができます。
アクティブなページのどこかを右クリックすると、Amazon Qが表示され、さまざまなオプションが表示されます。
これから、これらについて調べてみましょう。

* Explain - これは、あなたがハイライトしたものをAmazon Qチャットパネルに送信し、Amazon Qにこのコードが何をするのかを説明するよう依頼します。
* Refactor - これは、スニペットをレビューし、コードの可読性や効率などの改善方法を提案します。
* Fix - これは、コードにlintエラーがある場合や、コードの他の問題を解決しようとしている場合に便利です。
* Optimise - これは、選択したコードのパフォーマンスを最適化できるかどうかを調べます。
* Send to Prompt - これで選択した部分がコピーされ、Amazon Q Developer Chat Panelに移動します。そして、Amazon Q Developerに何をさせたいか、あなた自身のプロンプトを提供できます。これは自分でコードスニペットをコピー/ペーストするよりも簡単な方法です。
* Inline Chat - 編集中のファイル内に小さなダイアログボックスが表示され、プロンプトを入力できます。Amazon Qがコードを生成し、それを受け入れるか拒否するかを尋ねます（受け入れる場合はEnterを、拒否する場合はESCを押してください）。

レポジトリ内の[resources/in-menu.py](https://github.com/094459/q-developer-hands-on/blob/main/resources/in-menu.py)に、これらの練習ができるファイルがあります。
どのような出力が得られるか、それぞれを調べてみてください。

---

### 3. @Workspace を使う

前節では、Amazon Q Workplaceのインデックスを設定し、有効にする方法について説明しました。
ここでは、その仕組みについてもう少し深く掘り下げていきます。
この記事を書いている時点では、これはまだベータ版の機能ですので、その点はご留意ください。

**停止／開始**

プロジェクトで作業をしていると、@workspaceを使用する際にエラーが発生することがあります。
よくある問題の1つは、ローカルプロジェクトのファイルが変更されると（おそらくgitのチェックアウトが原因）、@workspaceがもう存在しないファイルに基づいて間違ったガイダンスを提供することがあります。
このような場合は、サービスを停止して再起動します。
そのためには次の手順を実施します。

1/ VSCodeステータスバーの下にあるAmazon Qメニューから「設定を開く」を選択します
2/ 「Amazon Q: Workspace Index」に移動します
3/ ボックスのチェックを外し、数秒待ってから再度チェックを入れます

**キャッシュをクリアする**

時折、ワークスペースインデックスを停止し、再起動しても問題は解決しません。
ログを開くとエラーメッセージが表示されます（私がよく見たのはFais index failureです）。
このような場合、キャッシュを削除し、Amazon Qにインデックスを再作成してもらうのが最善です。
Amazon Qのログを見ればキャッシュの場所がわかります。
以下は私のログからの抜粋です。

```
[Info  - 16:02:49] bm25 indexing complete, time: 0.92ms
[Info  - 16:02:49] start building tree index for /Users/ricsue/Projects/amazon-q/workshop/q-developer-workshop-supporting-repo/q-developer-workshop-demo-code
[Info  - 16:02:49] Finished parsing 1 python files. Time 15.07ms
[Info  - 16:02:49] start building vector index
[Info  - 16:02:49] Starting building vector index for 3 files
[Info  - 16:02:50] Vector index complete! Take 0.09364341600000001s. Total 3 files, 5 chunks
[Info  - 16:02:50] Vector index saved to /Users/ricsue/.aws/amazonq/cache/cache/eee4a16ba650a3c2a0cab92dd904c065feb5976341f32c94cd0be7fe5fcdd94a-0.9-VSCode.index
[Info  - 16:41:47] Adding file to vector index: /Users/ricsue/Projects/amazon-q/workshop/q-developer-workshop-supporting-repo/q-developer-workshop-demo-code/.qdeveloper/MY-PREFERENCES.md
```

このことから、 **~/.aws/amazonq/cache/** がワークスペースインデックスがこれらのインデックスを生成する場所であることがわかります。
これらは、インデックスプロセスが再作成するので、削除できます。

* 前の手順で「Amazon Q: Workplace Index」を無効にします
* ターミナルから、インデックスが作成されているディレクトリを探し、削除します
* ワークスペースインデックスを再度有効にします

インデックスは自動的に再作成され、ログで確認することができます。

**gitのブランチを扱う**

注意しなければならないのは、コードリポジトリの異なるブランチを頻繁にチェックしている場合、ワークスペースインデックスが更新されていない可能性があるということです。
つまり、コードの候補が以前のブランチにあったコードを参照したままになっている可能性があり、間違った出力をする可能性があるということです。
ブランチをチェックアウトしたら、インデックス処理を停止/開始します。

---

### 4. コンテキスト

コンテキストを理解することは、Amazon Q Developerがどのようにあなたを助けることができるかを理解し、影響を与える方法において非常に重要です。
この節では、Amazon Q Developerがあなたがやろうとしていることを理解するさまざまな方法を探ります。
コンテキストはすべてであり、Amazon Q Developerのようなツールで成功するための鍵です。

**モダリティ**

Amazon Qがどのようにコンテキストを取得するかは、どのように使用するかによって異なることを理解することが重要です。
インライン編集モダリティを使用している場合、Amazon Qが必要とする特性（非常に速く、インスタンス応答を提供する）は、コンテキストが非常に小さい（プロンプト自体）ことを意味します。
チャットインターフェイスを使用している場合、応答は即時である必要はないので、コンテキストはより大きくなります。
Amazon Qの中で異なるモダリティをどのように使用するか考えるとき、このことを覚えておいてください。

**ステートメントのインポート**

コードの最初に使いたいライブラリを追加することで、Amazon Qが提供する提案に影響を与えることができます。
たとえば、空白のプロジェクトファイルでPythonのWebフレームワークのコードを作成するようにAmazon Qに依頼すると、Flask、FastAPI、あるいはDjangoが表示されるかもしれません。
もし最初に `from flask import Flask` をページの一番上に追加すれば、ほとんどの場合Flaskのコード[^flask]を提供してくれるでしょう。

[^flask]: 非決定論的なシステムで100％の確証を得ることは不可能なので、私は「ほぼ」確実だと言っています。

**ファイルまたはタブを開く**

Amazon QがChatインターフェイスを使用する際にコンテキストを探す最初の場所は、IDE内で開いているファイルです。
Amazon Qを集中させるために必要なファイルだけを開いておくのは良い考えです。

加えて、Amazon Qは賢いので、重要なコンテキストがキーファイルから得られることを理解しています。
Javaプロジェクトで作業している場合、たとえばpom.xmlを読み込みます。

**小さいファイル**

コンテキストのサイズは非常に重要であり、そのサイズには限りがあるため、プロジェクトを小さなファイルに分割したほうがよい結果が得られるかもしれません。
そうすることで、それらのファイルを利用可能なコンテキストスペース内に置くことができるようになります。

**プロジェクトワークスペース**

Amazon Q Developer Workspace Indexを使用すると、プロジェクトのワークスペースにインデックスを付けることができます。
これは、質問をする際に複数のファイルを参照する必要がある場合に便利です。

モノリポジトリを使っている場合、1つ注意しなければならないことがあります。
あるプロジェクト（たとえばPython）で作業したくても、ワークスペースに他のコードがたくさんある場合、Amazon Qから得られるレスポンスは期待通りではないかもしれません。
あなたが作業しているプロジェクトが他の言語で書かれているにもかかわらず、JavaScriptやPythonが表示されるかもしれません。
これに対処する最善の方法は、IDEをモノリポジトリのサブフォルダで作業するようにセットアップし、ローカルのワークスペース内に邪魔なファイルを置かないようにすることです。

**カスタマイズ**

Amazon Q Developerでは、コードの提案に影響を与えるために独自のコードを提供することができます。
これは現在Professional Tierでのみ利用可能であり、今回のワークショップの対象ではありません。
この機能は非常に強力で、開発者が使用したいさまざまなカスタムコードに応じて使用できる多くのカスタマイズモデルを持つことができます。

詳しくは[このビデオ](https://www.youtube.com/watch?v=dsjXb4TvfPg)をご覧ください。

**スキャフォールド**

私たちは、スキャフォールドを提供することで、Amazon Qがどのように機能するかというアウトプットの舵取りを助けることができます。
これには2つの方法があります。

1/ プロジェクトディレクトリのMarkdownドキュメントに詳細を記述し、プロンプトでそれを参照する。
2/ プロンプト自体に直接記述する。

このリポジトリには、このチュートリアルで使用する雛形の例があります（[ここ](/specification/spec.md)）。
これらは、使用しているプログラミング言語、フレームワーク、個人的な好みなどの基準によって異なります。
ここで重要なのは、Amazon Q Developerの出力を調整するのに役立つということです。

/dev を使用する場合、プロンプト内でこれらのファイルを参照することで、作成されるコードのスキャフォールドを作ることができます。

---

### 5. プロンプトが機能しないとき

時折、プロンプトを入力すると、次のような応答が返ってきます。　

![Not accepting prompt](/images/q-vscode-context.png)

そのため、この問題を解決するためのヒントをいくつかご紹介します。

* Amazon Qは記憶とコンテキストを保持するため、同じ「会話」内にとどまり、より長い会話の一部であれば、この問題に遭遇する可能性は低くなります。
* 単語の順序を変える - 場合によっては、プロンプトを修正し、混乱させる可能性のある単語を削除する必要があるかもしれません。
* 別のプロンプトを試す - 同じ意図のまま、まったく別の単語を使ってみることもできます。

ほとんどの場合、これらで問題は解決します。

---

### 6. チャットインターフェイス

チャットインターフェイスを使用する際、いくつかの注意点があります。

**最大サイズ**

チャットインターフェースに入力できる文字数は最大4000文字です。
VSCode メニューとの統合を使用して、ハイライトされたコードを Amazon Q チャットインターフェースに送信する場合、この点に注意してください (Amazon Q > Send to Prompt)。
特に大きなファイルで作業している場合、制限を超えてしまい、プロンプトのためのスペースがなくなってしまうかもしれません。
チャットインターフェースの下にカウンターがあり、制限にどのくらい近づいているかを知ることができます。

**会話の履歴**

Amazon Qのチャットインターフェース（別名CHat Orientated Programming、CHOP）でやり取りをしている間、Amazon Qは会話の履歴を保持し、コンテキストを保持しています。
チャットタブを閉じたり、新しいタブを開きたくなるかもしれませんが、このコンテキストを維持することが、より良い回答を得るための鍵となります。

/clearコマンドで会話履歴を消去できます。
会話が一巡したり、回りくどくなったと感じたら、このコマンドを使ってください。

**チャットインターフェイスのタブ**

現在、最大10個のチャットウィンドウを持つことができます。

**コードのコピペ**

Amazon Qがチャットインターフェースでコードを作成するとき、コードブロックの下に2つのアイコンがあることに気づくでしょう。
COPYはコードをクリップボードにコピーし、INSERT INTO CURSORは、カーソルのある場所にコードをPASTEしようとします。
ここでの注意点は、カーソルはIDE内のファイル内にある必要があるということです - VSCode内のターミナルや他の場所には送られません。

これら2つのボタンを使うことで、チャットインターフェースからコードをあなたのコードに取り込むシンプルで素早い方法を提供します。

**差分を見て適用する**

Amazon Qプラグインの最近のアップデートでは、コードサジェストが既存のコードのアップデートである場合、VIEW DIFFとAPPLY DIFFという2つのボタンが表示されます。
これらは、あなたが持っているものとAmazon Qのチャット出力が提案しているものとのコードの違いを直接見ることができます。
その後、自動的にコンテンツを更新するためにAPPLY DIFFを使用できます。

---

### 7. Amazon Q Developer Agents

Amazon Q Developer Agentは、ソフトウェアの作成やアップデートを自動化するAmazon Q Developerの強力な機能です。
これを使う前に知っておくべきことがいくつかあります。

* 制限されたクォータ - エージェント（/dev、/test、/doc、/review など）を利用するためのクォータには限りがあるため、賢く利用する必要があります。Free Tier (Builder ID) を使用している場合、1ヶ月に5回の起動が可能です。
* /dev からの出力を絞り込む - /dev を使用すると、コードを再生成するフィードバックを提供する可能性があります。
これはサービスのクォータには含まれないので、/devの初期出力を注意深く確認し、「Provide Feedback and Regenerate」ボタンを使って必要な改良や更新を行う必要があります。ただし、これを実行できるのは3回までです。
* スキャフォールドを使用する - スキャフォールドについては以前触れましたが、これは /dev から得られるアウトプットの一貫性を確保するのに非常に役立つテクニックです。
* ユースケース - /dev に適したユースケースはたくさんあり、あなたがやろうとしていることに /dev と他の Amazon Q モダリティのどちらが適しているか、直感的に分かるようになるでしょう。

このワークショップの後半で /dev を使うので、その一部を実際に見ることができるでしょう。

---

### 8. コードリファレンス

Amazon Q Developerがコードサジェストを提供するとき、そのコードのどれだけが、その背後にある大規模な言語モデルを訓練するために使用されるオープンソースプロジェクトから来るかもしれないという疑問があるかもしれません。
Amazon Q Developerでは、これを設定できます - オープンソースリポジトリからのコードにマッチするコードサジェストを明示的にオフにするか、または有効にしたままにしておくことができ、Amazon Q Developerが通知します。
実際には、このような事態に遭遇することはほとんどありません。

この[非常に短いビデオ](https://www.youtube.com/shorts/Fmn37wGQUY8)をご覧ください。
これが実際に起こったときにどのように見えるかを示しています。

### 完了です！

さて、あなたはAmazon Q Developerプラグインを使いこなせるようになりました。
そして今こそ、それで何が達成できるかを確認するときです。
次のセクション[問題の分解](04-breaking-down-problems.md)に進んでください。

Ok, you are now up to speed with the Amazon Q Developer plugin, and it is time to see what you can achieve with it. Head over to the next section [Breaking down problems](04-breaking-down-problems.md).

